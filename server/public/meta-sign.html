<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MetaMask Sign Helper</title>
  <style>
    body {font-family: Inter, system-ui, sans-serif; padding:20px; max-width:900px}
    pre{background:#0b1220;color:#d1d5db;padding:12px;border-radius:8px;overflow:auto}
    textarea{width:100%;height:80px}
    button{padding:8px 12px;border-radius:8px;background:#0f172a;color:#fff;border:none}
  </style>
</head>
<body>
  <h2>MetaMask Sign Helper</h2>
  <p>This page must be opened in a browser with MetaMask installed. It receives typedData (base64 in URL param `td`).</p>

  <div>
    <label><strong>Typed Data (decoded):</strong></label>
    <pre id="typedDataPre"></pre>
  </div>

  <div style="margin-top:12px">
    <button id="connectBtn">Connect MetaMask</button>
    <button id="signBtn" disabled>Sign Typed Data with MetaMask</button>
  </div>

  <div style="margin-top:12px">
    <label><strong>Signature (copy this back to desktop):</strong></label>
    <textarea id="sigOut" readonly></textarea>
    <div style="margin-top:6px">
      <button id="copyBtn">Copy signature</button>
    </div>
  </div>

  <script>
    function getParam(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }
    function b64DecodeUnicode(str) {
      try {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      } catch(e) { return null; }
    }

    const tdParam = getParam('td');
    if (!tdParam) {
      document.getElementById('typedDataPre').textContent = 'No typedData provided. Open this page with ?td=<base64>';
    } else {
      const decoded = b64DecodeUnicode(tdParam);
      try {
        const obj = JSON.parse(decoded);
        document.getElementById('typedDataPre').textContent = JSON.stringify(obj, null, 2);
        window.typedData = obj;
        document.getElementById('signBtn').disabled = false;
      } catch(e){
        document.getElementById('typedDataPre').textContent = 'Invalid typedData';
      }
    }

    document.getElementById('connectBtn').onclick = async () => {
      if (!window.ethereum) return alert('MetaMask not found in this browser.');
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        alert('MetaMask connected.');
      } catch(e) { alert('Connection failed: ' + e.message); }
    };

    document.getElementById('signBtn').onclick = async () => {
      if (!window.ethereum) return alert('MetaMask not found.');
      if (!window.typedData) return alert('typedData not loaded');
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const signer = accounts[0];
        // Use eth_signTypedData_v4 so MetaMask shows a typed UI
        const sig = await window.ethereum.request({
          method: 'eth_signTypedData_v4',
          params: [signer, JSON.stringify(window.typedData)]
        });
        document.getElementById('sigOut').value = sig;
      } catch (err) {
        alert('Signing failed: ' + (err.message || err));
      }
    };

    document.getElementById('copyBtn').onclick = () => {
      const t = document.getElementById('sigOut');
      t.select();
      document.execCommand('copy');
      alert('Signature copied to clipboard. Paste it into the desktop app.');
    };
  </script>
</body>
</html>
